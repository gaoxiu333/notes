---
title: è£…é¥°å™¨æ¨¡å¼
jd_id: 30.00.1002
created: 2023-10-21 09:45
updated: 2023-10-21 09:45
type: snippet
status: active
language: python
schema: v1
tags: [lang/python, topic/design-pattern, topic/decorator]
complexity: 3
reusability: 5
performance: 4
maintainability: 4
tested: true
environment: all
---

# Pythonè£…é¥°å™¨æ¨¡å¼

## ğŸ“ æ¦‚è¿°

Pythonè£…é¥°å™¨æ˜¯ä¸€ç§å¼ºå¤§çš„è®¾è®¡æ¨¡å¼ï¼Œå…è®¸åœ¨ä¸ä¿®æ”¹åŸå§‹å‡½æ•°ä»£ç çš„æƒ…å†µä¸‹æ‰©å±•å…¶åŠŸèƒ½ã€‚æœ¬ä»£ç ç‰‡æ®µæ¼”ç¤ºäº†å¦‚ä½•åˆ›å»ºå’Œä½¿ç”¨è£…é¥°å™¨ï¼ŒåŒ…æ‹¬åŸºæœ¬è£…é¥°å™¨ã€å¸¦å‚æ•°çš„è£…é¥°å™¨å’Œç±»è£…é¥°å™¨ä¸‰ç§ç±»å‹ã€‚

## ğŸ§© ä»£ç 

### åŸºæœ¬è£…é¥°å™¨

```python
import functools
import time
from typing import Callable, Any, TypeVar

F = TypeVar('F', bound=Callable[..., Any])

def timer(func: F) -> F:
    """
    è®¡æ—¶è£…é¥°å™¨ï¼šè®°å½•å‡½æ•°æ‰§è¡Œæ—¶é—´
    
    Args:
        func: è¦è£…é¥°çš„å‡½æ•°
        
    Returns:
        è£…é¥°åçš„å‡½æ•°
    """
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        end_time = time.time()
        print(f"å‡½æ•° {func.__name__} æ‰§è¡Œæ—¶é—´: {end_time - start_time:.4f} ç§’")
        return result
    return wrapper  # type: ignore
```

### å¸¦å‚æ•°çš„è£…é¥°å™¨

```python
def retry(attempts: int = 3, delay: float = 1.0):
    """
    é‡è¯•è£…é¥°å™¨ï¼šåœ¨å‡½æ•°å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
    
    Args:
        attempts: æœ€å¤§é‡è¯•æ¬¡æ•°
        delay: é‡è¯•ä¹‹é—´çš„å»¶è¿Ÿï¼ˆç§’ï¼‰
        
    Returns:
        è£…é¥°å™¨å‡½æ•°
    """
    def decorator(func: F) -> F:
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(1, attempts + 1):
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    if attempt == attempts:
                        raise
                    print(f"å°è¯• {attempt}/{attempts} å¤±è´¥: {e}ï¼Œ{delay}ç§’åé‡è¯•...")
                    time.sleep(delay)
        return wrapper  # type: ignore
    return decorator
```

### ç±»è£…é¥°å™¨

```python
class Memoize:
    """
    ç¼“å­˜è£…é¥°å™¨ï¼šç¼“å­˜å‡½æ•°çš„è¿”å›å€¼
    """
    def __init__(self, func: Callable):
        self.func = func
        self.cache = {}
        functools.update_wrapper(self, func)
        
    def __call__(self, *args, **kwargs):
        # åˆ›å»ºå¯å“ˆå¸Œçš„é”®
        key = str(args) + str(kwargs)
        if key not in self.cache:
            self.cache[key] = self.func(*args, **kwargs)
        return self.cache[key]
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

```python
# åŸºæœ¬è£…é¥°å™¨ç¤ºä¾‹
@timer
def factorial(n: int) -> int:
    """è®¡ç®—é˜¶ä¹˜"""
    return 1 if n <= 1 else n * factorial(n - 1)

result = factorial(10)
print(f"10çš„é˜¶ä¹˜æ˜¯: {result}")
# è¾“å‡º: å‡½æ•° factorial æ‰§è¡Œæ—¶é—´: 0.0001 ç§’
# è¾“å‡º: 10çš„é˜¶ä¹˜æ˜¯: 3628800

# å¸¦å‚æ•°çš„è£…é¥°å™¨ç¤ºä¾‹
@retry(attempts=3, delay=0.5)
def unstable_function():
    """ä¸€ä¸ªä¸ç¨³å®šçš„å‡½æ•°ï¼Œæœ‰20%æ¦‚ç‡æˆåŠŸ"""
    import random
    if random.random() < 0.8:
        raise ConnectionError("è¿æ¥å¤±è´¥")
    return "æˆåŠŸ!"

try:
    result = unstable_function()
    print(result)
except Exception as e:
    print(f"æœ€ç»ˆå¤±è´¥: {e}")

# ç±»è£…é¥°å™¨ç¤ºä¾‹
@Memoize
def fibonacci(n: int) -> int:
    """è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—ç¬¬né¡¹"""
    if n < 2:
        return n
    return fibonacci(n - 1) + fibonacci(n - 2)

print(fibonacci(30))  # ä¸ä½¿ç”¨ç¼“å­˜ä¼šéå¸¸æ…¢ï¼Œä½†ä½¿ç”¨ç¼“å­˜åå¾ˆå¿«
# è¾“å‡º: 832040
```

## ğŸ“Š å‚æ•°è¯´æ˜

### timerè£…é¥°å™¨

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | å¿…å¡« | æè¿° |
|-------|------|-------|------|------|
| func | Callable | - | âœ… | è¦è£…é¥°çš„å‡½æ•° |

### retryè£…é¥°å™¨

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | å¿…å¡« | æè¿° |
|-------|------|-------|------|------|
| attempts | int | 3 | âŒ | æœ€å¤§é‡è¯•æ¬¡æ•° |
| delay | float | 1.0 | âŒ | é‡è¯•ä¹‹é—´çš„å»¶è¿Ÿï¼ˆç§’ï¼‰|

### Memoizeç±»è£…é¥°å™¨

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | å¿…å¡« | æè¿° |
|-------|------|-------|------|------|
| func | Callable | - | âœ… | è¦ç¼“å­˜ç»“æœçš„å‡½æ•° |

## ğŸ“‹ è¿”å›å€¼

æ‰€æœ‰è£…é¥°å™¨éƒ½è¿”å›è£…é¥°åçš„å‡½æ•°æˆ–å¯è°ƒç”¨å¯¹è±¡ï¼Œä¿ç•™åŸå§‹å‡½æ•°çš„è¿”å›å€¼ã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

- ä½¿ç”¨`functools.wraps`ä¿ç•™åŸå‡½æ•°çš„å…ƒæ•°æ®ï¼ˆåç§°ã€æ–‡æ¡£å­—ç¬¦ä¸²ç­‰ï¼‰
- ç¼“å­˜è£…é¥°å™¨å¯¹äºå¸¦æœ‰å‰¯ä½œç”¨çš„å‡½æ•°ä¸é€‚ç”¨
- å¸¦å‚æ•°çš„è£…é¥°å™¨æ˜¯åµŒå¥—çš„ä¸‰å±‚å‡½æ•°ï¼Œå®¹æ˜“å‡ºé”™
- è£…é¥°å™¨çš„æ‰§è¡Œé¡ºåºæ˜¯ä»ä¸‹åˆ°ä¸Šï¼ˆæœ€é è¿‘å‡½æ•°å®šä¹‰çš„è£…é¥°å™¨æœ€å…ˆæ‰§è¡Œï¼‰
- ç±»è£…é¥°å™¨å¯èƒ½ä¼šæ”¹å˜å‡½æ•°çš„ç±»å‹ç­¾åï¼Œå½±å“ç±»å‹æ£€æŸ¥

## ğŸ” å·¥ä½œåŸç†

è£…é¥°å™¨æ˜¯ä¸€ä¸ªæ¥å—å‡½æ•°ä½œä¸ºå‚æ•°å¹¶è¿”å›æ–°å‡½æ•°çš„é«˜é˜¶å‡½æ•°ã€‚å½“ä½¿ç”¨`@decorator`è¯­æ³•æ—¶ï¼ŒPythonè§£é‡Šå™¨ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

```python
# è¿™ä¸ªè¯­æ³•:
@decorator
def func():
    pass

# ç­‰ä»·äº:
func = decorator(func)
```

å¸¦å‚æ•°çš„è£…é¥°å™¨å®é™…ä¸Šè¿”å›ä¸€ä¸ªè£…é¥°å™¨å‡½æ•°ï¼ŒPythonä¼šå…ˆè°ƒç”¨å¤–å±‚å‡½æ•°ï¼Œç„¶åä½¿ç”¨è¿”å›çš„è£…é¥°å™¨è£…é¥°ç›®æ ‡å‡½æ•°ã€‚

## ğŸ”„ æ›¿ä»£æ–¹æ¡ˆ

- ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆwithè¯­å¥ï¼‰
- ä½¿ç”¨ç»§æ‰¿å’Œç»„åˆæ¨¡å¼å®ç°åŠŸèƒ½æ‰©å±•
- ä½¿ç”¨é«˜é˜¶å‡½æ•°æ‰‹åŠ¨åŒ…è£…ç›®æ ‡å‡½æ•°
- ä½¿ç”¨Pythonçš„ç¬¬ä¸‰æ–¹åº“å¦‚`functools`æˆ–`wrapt`æä¾›çš„å¢å¼ºè£…é¥°å™¨

## ğŸ“š ç›¸å…³ä»£ç ç‰‡æ®µ

- [[ä¸Šä¸‹æ–‡ç®¡ç†å™¨]]
- [[å•ä¾‹æ¨¡å¼]]
- [[å‡½æ•°ç¼“å­˜]]

## ğŸ”— ç›¸å…³æ¦‚å¿µ

- [[Pythonå‡½æ•°å¼ç¼–ç¨‹]]
- [[è®¾è®¡æ¨¡å¼-è£…é¥°å™¨æ¨¡å¼]]

## ğŸ“– å‚è€ƒèµ„æ–™

- [Pythonå®˜æ–¹æ–‡æ¡£ - è£…é¥°å™¨](https://docs.python.org/zh-cn/3/glossary.html#term-decorator)
- [Real Python - è£…é¥°å™¨æ•™ç¨‹](https://realpython.com/primer-on-python-decorators/)
- [PEP 318 â€“ å‡½æ•°å’Œæ–¹æ³•çš„è£…é¥°å™¨](https://peps.python.org/pep-0318/)

## ğŸ“ ä½¿ç”¨æƒ…å¢ƒ

- æ€§èƒ½æµ‹é‡å’Œåˆ†æ
- è®¿é—®æ§åˆ¶å’Œè®¤è¯
- æ—¥å¿—è®°å½•å’Œé”™è¯¯å¤„ç†
- ç¼“å­˜å’Œç»“æœé‡ç”¨
- è¾“å…¥éªŒè¯å’Œé¢„å¤„ç†
- äº‹åŠ¡ç®¡ç†å’Œèµ„æºåˆ†é…

## ğŸ·ï¸ ä¿®æ”¹å†å²

- 2023-10-21 - åˆ›å»ºåˆå§‹ç‰ˆæœ¬ 