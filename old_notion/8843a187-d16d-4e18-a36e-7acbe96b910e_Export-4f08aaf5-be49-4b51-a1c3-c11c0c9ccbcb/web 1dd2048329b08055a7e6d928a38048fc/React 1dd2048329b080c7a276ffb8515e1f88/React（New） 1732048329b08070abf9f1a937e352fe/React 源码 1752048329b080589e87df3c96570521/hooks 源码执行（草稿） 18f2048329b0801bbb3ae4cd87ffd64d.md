# hooks 源码执行（草稿）

# React 全局变量总结

这些全局变量在 React 渲染过程中用于管理 **组件渲染** 和 **Hooks**，它们与 **Fiber 架构** 和 **渲染调度** 密切相关。以下是这些变量的作用以及它们之间的关系：

## 1. 核心变量

### `currentlyRenderingFiber: Fiber = null`

- **作用**：指向当前正在渲染的 **Fiber 节点**，用于帮助 React 管理和更新该节点对应组件的状态和副作用。
- **关系**：每当 React 渲染某个组件时，`currentlyRenderingFiber` 会指向该组件的 Fiber 节点，从而确保 Hooks 和状态更新与当前组件关联。

### `ReactCurrentDispatcher.current`

- **作用**：React Hooks 的 **动态分发器**，决定了当前渲染阶段（挂载或更新）使用哪个 Hooks 实现。
- **工作原理**：
    - 在挂载阶段，`ReactCurrentDispatcher.current` 会指向 `HooksDispatcherOnMount`，这会调用用于挂载的 Hooks（例如 `useState`、`useEffect`）。
    - 在更新阶段，`ReactCurrentDispatcher.current` 会指向 `HooksDispatcherOnUpdate`，这会调用更新阶段的 Hooks。
- **总结**：`ReactCurrentDispatcher.current` 的动态切换确保了在不同渲染阶段（挂载和更新）执行不同的 Hook 逻辑。

### `currentHook: Hook | null = null`

- **作用**：指向当前正在渲染的 Hook 链表（用于挂载阶段）。用于追踪和管理当前组件的 Hooks 状态。（**代表上一次渲染周期的hooks状态**）

### `workInProgressHook: Hook | null = null`

- **作用**：指向 **工作中的 Hook 链表**（用于更新阶段）。它在渲染更新过程中保存更新中的 Hook 状态，确保更新时 Hooks 的正确执行和状态维护。（渲染阶段临时保存的hooks状态，和currentHook比较哪些地方有更新，渲染后更新至currentHook）

## 2. 渲染阶段和更新状态相关变量

### `didScheduleRenderPhaseUpdate: boolean = false`

- **作用**：标记 **渲染阶段** 是否调度了更新。如果为 `true`，表示在渲染过程中有更新被调度。

### `didScheduleRenderPhaseUpdateDuringThisPass: boolean = false`

- **作用**：记录 **当前渲染过程** 是否调度了更新。它帮助 React 跟踪当前渲染是否需要进行额外的更新操作。

### `localIdCounter: number = 0`

- **作用**：用于计数当前组件中 `useId` 调用的次数，确保每次生成的 ID 在组件内是唯一的。

### `globalClientIdCounter: number = 0`

- **作用**：一个 **全局唯一的 ID 计数器**，用于生成客户端渲染时的唯一 ID。确保客户端生成的 ID 在整个应用中是唯一的。

## 3. 设计和优化考量

### 为什么是全局变量？

- **递归渲染和内存管理**：React 的渲染是递归的，组件可能有嵌套渲染。通过使用全局变量来管理渲染过程中的状态和 Hooks，React 可以避免频繁的内存分配和释放，从而优化内存使用，减少性能开销。
- **支持嵌套渲染**：React 的 Fiber 架构支持嵌套渲染（例如，父组件渲染子组件）。通过全局变量，React 可以在整个渲染树中有效地跟踪和管理每个组件的状态和副作用，避免内存泄漏，并确保每个组件都能正确地使用 Hooks。

### 内存管理的考虑：

- 由于 React 的渲染过程是递归的，如果每个渲染阶段都创建局部变量来管理组件的状态和副作用，可能会导致大量不必要的内存分配和清理。使用全局变量能够减少这种开销。
- 全局变量确保 React 仅需在 **一次渲染过程中** 管理这些状态，而不需要为每次渲染或更新都进行过多的内存分配操作。

---

## 总结

这些全局变量是 React 内部用来处理渲染和更新过程中的 **组件状态**、**副作用** 和 **Hooks 管理** 的关键工具。它们帮助 React 在不同阶段（挂载、更新）灵活地分发和管理 **Hooks**，同时避免了过多的内存分配和优化了性能。`currentlyRenderingFiber` 和 `ReactCurrentDispatcher.current` 的组合，确保了每个渲染阶段的 **Hooks 分发** 和 **组件状态更新** 既高效又正确。

## 小结

链式结构经典赋值

```jsx
    hook1 = {}
    hook2 = {}
    workInProgressHook = hook1 
    workInProgressHook = workInProgressHook.next = hook2;
    // 最终 hook1 的 next 指向 hook2 
```