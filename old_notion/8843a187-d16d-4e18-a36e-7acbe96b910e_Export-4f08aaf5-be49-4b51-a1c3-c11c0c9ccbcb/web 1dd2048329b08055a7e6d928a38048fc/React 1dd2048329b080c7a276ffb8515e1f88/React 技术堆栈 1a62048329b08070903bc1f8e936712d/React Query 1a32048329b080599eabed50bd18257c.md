# React Query

## æ ¸å¿ƒæœºåˆ¶åŸç†

### **1. Query Key è®¾è®¡åŸåˆ™**

- æ•°ç»„ç»“æ„ï¼Œå±‚çº§åŒ–ç»„ç»‡ï¼ˆç±»ä¼¼ URL è·¯å¾„ï¼‰
    
    `['users', { page: 1 }, 'details']`
    
- **ç›¸åŒ Key å¤ç”¨ç¼“å­˜**ï¼Œä¸åŒ Key åˆ›å»ºæ–°æŸ¥è¯¢
- åŠ¨æ€éƒ¨åˆ†æ”¾åé¢ï¼š`['config', region]`

### **2. æ•°æ®ç”Ÿå‘½å‘¨æœŸï¼ˆå†ç»†åŒ–ä¸€ä¸‹ï¼‰**

```bash
fresh â†’ stale â†’ inactive â†’ garbage collected
  â”‚        â”‚         â”‚
  â”‚        â”‚         â””â”€ æ— è§‚å¯Ÿè€…æ—¶è¿›å…¥ä¼‘çœ 
  â”‚        â””â”€ è§¦å‘åå°é‡æ–°éªŒè¯ (staleTime é»˜è®¤ 0)
  â””â”€ ç›´æ¥ä½¿ç”¨ç¼“å­˜ (staleTime > 0 æ—¶)
```

### **3. è¯·æ±‚ç«æ€å¤„ç†**

- è‡ªåŠ¨å–æ¶ˆé‡å¤è¯·æ±‚ (é»˜è®¤è¡Œä¸º)
- æœ€åä¸€æ¬¡è¯·æ±‚ç»“æœè¦†ç›–ä¹‹å‰ç»“æœ

## åˆå§‹åŒ–

- [eslint](https://tanstack.com/query/v5/docs/eslint/eslint-plugin-query)
- [devtools](https://tanstack.com/query/v5/docs/framework/react/devtools)

```bash
pnpm add @tanstack/react-query
pnpm add -D @tanstack/react-query-devtools @tanstack/eslint-plugin-query
```

### **é…ç½®æ¶æ„å›¾**

```jsx
QueryClient
â”œâ”€â”€ Default Options  # å…¨å±€é»˜è®¤è®¾ç½®
â”‚   â”œâ”€â”€ queries      # æ‰€æœ‰æŸ¥è¯¢çš„é»˜è®¤è¡Œä¸º
â”‚   â””â”€â”€ mutations    # æ‰€æœ‰å˜æ›´çš„é»˜è®¤è¡Œä¸º
â”œâ”€â”€ QueryCache       # ç¼“å­˜å­˜å‚¨å¼•æ“
â”œâ”€â”€ MutationCache    # å˜æ›´æ“ä½œå­˜å‚¨
â””â”€â”€ Logger           # è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ
```

### **é…ç½®åŸç†é€Ÿè®°è¡¨**

**æ ¸å¿ƒé€‰é¡¹ï¼ˆoptionsï¼‰**

| **å­—æ®µ** | **ç±»å‹** | **æè¿°** |
| --- | --- | --- |
| **enabled** | `boolean` | æ˜¯å¦å¯ç”¨è‡ªåŠ¨æŸ¥è¯¢ï¼ˆé»˜è®¤Â `true`ï¼‰ã€‚è®¾ä¸ºÂ `false`Â æ—¶éœ€æ‰‹åŠ¨è§¦å‘Â `refetch`ã€‚ |
| **staleTime** | `number` | æ•°æ®ä¿é²œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé¿å…é‡å¤è¯·æ±‚ |
| **gcTime** | `number` | GCåƒåœ¾å›æ”¶ï¼Œå¤±æ´»åå¤šä¹…è¢«å›æ”¶ |
| **refetchOnWindowFocus** | **`boolean`** | åˆ‡æµè§ˆå™¨ tab æ˜¯å¦åˆ·æ–°ï¼Œé»˜è®¤ tureï¼Œä½†é€šå¸¸ä¸éœ€è¦ |
| **networkMode** | `'online' | 'always' | 'offlineFirst'` | æ§åˆ¶ç½‘ç»œè¡Œä¸ºï¼ˆå¦‚ç¦»çº¿å¤„ç†ï¼‰ã€‚ |

æ›´è¯¦ç»†çš„é…ç½®ï¼š[useQuery](https://tanstack.com/query/v5/docs/framework/react/reference/useQuery)

**é…ç½®è®°å¿†é”šç‚¹**

1. **ç¼“å­˜åŒå‘¨æœŸ**ï¼š`staleTime`Â (é€»è¾‘å‘¨æœŸ) å’ŒÂ `gcTime`Â (ç‰©ç†å‘¨æœŸ) è§£è€¦è®¾è®¡
2. **é”™è¯¯å¤„ç†é“¾**ï¼šå±€éƒ¨ onError > å…¨å±€ onError > é”™è¯¯è¾¹ç•Œ (Error Boundary)
3. **åˆ†å±‚ç”Ÿæ•ˆ**ï¼šuseQueryé€‰é¡¹ > å…¨å±€ defaults > æ¡†æ¶é»˜è®¤å€¼
4. **ç¼“å­˜é”®éš”ç¦»**ï¼šä¸åŒ QueryClient å®ä¾‹å®Œå…¨éš”ç¦»ç¼“å­˜

### **å…¨å±€é»˜è®¤é…ç½®ç¤ºä¾‹ (`defaultOptions`)**

```jsx
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 60 * 1000,    // æ•°æ®ä¿é²œæœŸï¼ˆé»˜è®¤0å³ç«‹å³è¿‡æœŸï¼‰
      gcTime: 5 * 60 * 1000,   // ç¼“å­˜ä¿ç•™æ—¶é—´ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰
      retry: 3,                // é”™è¯¯é‡è¯•æ¬¡æ•°ç­–ç•¥
      refetchOnWindowFocus: false, // çª—å£èšç„¦æ—¶åˆ·æ–°
      networkMode: 'online'     // ç¦»çº¿æ¨¡å¼å¤„ç†ç­–ç•¥
    },
    mutations: {
      retry: 0                 // å˜æ›´é»˜è®¤ä¸é‡è¯•
    }
  }
})
```

**åŸç†è¦ç‚¹**ï¼š

- `staleTime > 0`Â ä¼šå»¶è¿Ÿåå°åˆ·æ–°è§¦å‘
- `gcTime`Â å½±å“å†…å­˜å ç”¨å’Œæ¢å¤èƒ½åŠ›
- `networkMode`Â æ§åˆ¶ç¦»çº¿æ—¶çš„è¯·æ±‚é˜Ÿåˆ—è¡Œä¸º

**ç¼“å­˜å¼•æ“é…ç½® (`QueryCache`)**

```jsx
const queryClient = new QueryClient({
  queryCache: new QueryCache({
    onError: (err) => {},          // å…¨å±€é”™è¯¯æ•è·
    onSuccess: (data) => {},       // å…¨å±€æˆåŠŸå›è°ƒ
    onSettled: (data, err) => {}   // å…¨å±€å®Œæˆå›è°ƒ
  })
})
```

**æœºåˆ¶è¯´æ˜**ï¼š

- æ¯ä¸ª QueryClient ç‹¬ç«‹ç»´æŠ¤ç¼“å­˜å®ä¾‹
- å¯åˆ›å»ºå¤šä¸ª QueryClient å®ç°æ²™ç®±éš”ç¦»

### **å¼€å‘å·¥å…·é›†æˆ**

```jsx
// å¼€å‘ç¯å¢ƒä¸‹å¯ç”¨è°ƒè¯•å·¥å…·
import { ReactQueryDevtools } from '@tanstack/react-query-devtools'

function App() {
  return (
    <>
      <QueryClientProvider client={queryClient}>
        {/* åº”ç”¨ç»„ä»¶ */}
      </QueryClientProvider>
      <ReactQueryDevtools 
        initialIsOpen={false} 
        position="bottom-right" 
        toggleButtonProps={{ style: { right: '5px' } }} 
      />
    </>
  )
}
```

**è°ƒè¯•åŸç†**ï¼š

- å®æ—¶æ˜¾ç¤ºç¼“å­˜çŠ¶æ€æ ‘
- æ‰‹åŠ¨è§¦å‘ç¼“å­˜å¤±æ•ˆ/åˆ·æ–°
- å¯è§†åŒ–è§‚å¯Ÿè€…ä¾èµ–å…³ç³»

å…¶ä»–é…ç½®ï¼š

- æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰é…ç½®
- ç¦»çº¿ä¼˜å…ˆç­–ç•¥
- æ€§èƒ½ä¼˜åŒ–é…ç½®

## æ ¸å¿ƒ API åŸç†é€Ÿè®°

### useQuery

å‚è€ƒï¼š[useQuery](https://tanstack.com/query/v5/docs/framework/react/reference/useQuery)

```jsx
const { 
	 data,
	 status,
	 refetch,           // æ‰‹åŠ¨åˆ·æ–°
	 error,
	 isPending,         // æ˜¯å¦å¤„äºé¦–æ¬¡åŠ è½½çŠ¶æ€ï¼ˆæ— ç¼“å­˜æ•°æ®æ—¶ï¼‰ã€‚
	 isFetching,        // æ˜¯å¦æ­£åœ¨è¯·æ±‚ä¸­ï¼ˆåŒ…æ‹¬åå°åˆ·æ–°ï¼‰ã€‚

 } = useQuery({
  queryKey: ['todos'],       // ç¼“å­˜å®šä½æ ‡è¯†
  queryFn: fetchTodos,       // å®é™…æ•°æ®è·å–å‡½æ•°
  staleTime: 10_000,         // æ–°é²œâ†’è¿‡æœŸçŠ¶æ€åˆ‡æ¢æ—¶é—´
  gcTime: 30_000,            // å†…å­˜ä¿ç•™æ—¶é—´
  retry: 3                   // é”™è¯¯é‡è¯•ç­–ç•¥
})
```

### **é«˜çº§åŠŸèƒ½**

- **ä¾èµ–æŸ¥è¯¢**ï¼šé€šè¿‡Â `enabled: false`Â å’Œæ‰‹åŠ¨è°ƒç”¨Â `refetch`Â å®ç°ä¾èµ–å…¶ä»–æŸ¥è¯¢çš„è§¦å‘é€»è¾‘ã€‚
- **åˆ†é¡µæŸ¥è¯¢**ï¼šç»“åˆÂ `keepPreviousData: true`Â ä¿ç•™æ—§æ•°æ®ï¼Œæå‡åˆ†é¡µä½“éªŒã€‚
- **é¢„åŠ è½½**ï¼šä½¿ç”¨Â `queryClient.prefetchQuery`Â æå‰åŠ è½½æ•°æ®åˆ°ç¼“å­˜

### **useMutation**

```jsx
const mutation = useMutation({
  mutationFn: postData,
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ['items'] }) // å¤±æ•ˆæ—§ç¼“å­˜
  },
  retry: false // çªå˜é»˜è®¤ä¸é‡è¯•
})
```

## ç‰¹æ€§

### é¢„åŠ è½½æ¨¡å¼

```jsx
// æå‰å°†æ•°æ®æ”¾å…¥ç¼“å­˜
await queryClient.prefetchQuery({
  queryKey: ['user', userId],
  queryFn: () => fetchUser(userId)
})
```

### æ‰‹åŠ¨ç¼“å­˜

```jsx
/ ç›´æ¥å†™å…¥ç¼“å­˜
queryClient.setQueryData(['todo', id], newTodo)

// è·å–ç¼“å­˜å¿«ç…§
const cached = queryClient.getQueryData(['todo', id])

// æ‰¹é‡å¤±æ•ˆç¼“å­˜
queryClient.invalidateQueries({ queryKey: ['todos'] })
```

### é”™è¯¯å¤„ç†

```jsx
// å…¨å±€é”™è¯¯å¤„ç†
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      onError: (err) => handleGlobalError(err)
    }
  }
})

// æœ¬åœ°é”™è¯¯å¤„ç†
useQuery({
  queryKey: ['data'],
  queryFn: fetchData,
  onError: (err) => handleLocalError(err)
})
```

---

<aside>
ğŸ’¡

## **åŸç†å‘é€Ÿè®°æŠ€å·§**

1. **ç¼“å­˜ç›®å½•**ï¼šæŠŠÂ `queryKey`Â æƒ³è±¡æˆæ–‡ä»¶è·¯å¾„
    
    `['users', 'list', { page: 2 }]`Â â†’Â `/users/list?page=2`
    
2. **çŠ¶æ€æµè½¬**ï¼šç”»æ—¶é—´è½´ç†è§£ fresh/stale/inactive
3. **ä¾èµ–å…³ç³»**ï¼šç»„ä»¶å¸è½½ = è§‚å¯Ÿè€…å–æ¶ˆè®¢é˜… â‰  ç¼“å­˜åˆ é™¤
4. **æ€§èƒ½å…³é”®**ï¼š`staleTime`Â å’ŒÂ `gcTime`Â çš„å¹³è¡¡è‰ºæœ¯
</aside>

## TODO

### TypeScript æ”¯æŒ

https://tanstack.com/query/v5/docs/framework/react/typescript

### æ’ä»¶

- `@tanstack/react-query-persist-client` æŒä¹…åŒ–ç¼“å­˜ï¼ˆstorageï¼‰
- è¿˜æœ‰ eslint

### QueryClient

- ç»å¸¸ä½¿ç”¨çš„æ–¹æ³•æœ‰å“ªäº›

### Options

- **staleTime**
- gcTime
- **initialData**
- **refetchOnWindowFocus æµè§ˆå™¨åå°åˆ‡å‰å°ååˆ·æ–°æ•°æ®**
- placeholderData VS initialData
- **select**
- **suspense éœ€è¦ Error Boundary**

è¿”å›

- isPending VS isFetching
- **refetch**

### **é«˜çº§åŠŸèƒ½**

- **ä¾èµ–æŸ¥è¯¢**ï¼šé€šè¿‡Â `enabled: false`Â å’Œæ‰‹åŠ¨è°ƒç”¨Â `refetch`Â å®ç°ä¾èµ–å…¶ä»–æŸ¥è¯¢çš„è§¦å‘é€»è¾‘ã€‚
- **åˆ†é¡µæŸ¥è¯¢**ï¼šç»“åˆÂ `keepPreviousData: true`Â ä¿ç•™æ—§æ•°æ®ï¼Œæå‡åˆ†é¡µä½“éªŒã€‚
- **é¢„åŠ è½½**ï¼šä½¿ç”¨Â `queryClient.prefetchQuery`Â æå‰åŠ è½½æ•°æ®åˆ°ç¼“å­˜ã€‚

### **æ³¨æ„äº‹é¡¹**

1. **ç¼“å­˜ç­–ç•¥**ï¼š`staleTime`Â å’ŒÂ `gcTime`Â æ§åˆ¶æ•°æ®çš„ä¿é²œå’Œåƒåœ¾å›æ”¶ã€‚
2. **TypeScript**ï¼šå¯é€šè¿‡æ³›å‹æŒ‡å®šæ•°æ®ç±»å‹ï¼ˆå¦‚Â `useQuery<TData, TError>`ï¼‰ã€‚
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨Â `select`Â å’ŒÂ `structuralSharing`Â é¿å…ä¸å¿…è¦çš„æ¸²æŸ“