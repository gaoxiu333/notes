# 基础

## 特点

大多数mock在应用几倍提供请求拦截进行mock，Mock Service Worker 在**网络级别拦截请求**

## 参考

**常用API**

- [查询参数](https://mswjs.io/docs/concepts/response-resolver#arguments)
- [HTTPResponse](https://mswjs.io/docs/api/http-response)
- [http](https://mswjs.io/docs/api/http)
- [delay](https://mswjs.io/docs/api/delay)

**example**

- [url 参数](https://mswjs.io/docs/recipes/query-parameters#read-multi-value-parameter)
- [轮询](https://mswjs.io/docs/recipes/polling)
- [全局响应延迟](https://mswjs.io/docs/recipes/global-response-delay)
- [权限控制](https://mswjs.io/docs/recipes/higher-order-resolver)
- [https](https://mswjs.io/docs/recipes/using-local-https)

### 请求响应

- `HttpResponse.error()`  网络错误
- `HttpResponse.text()` 文本
- `HttpResponse.json()`  返回 json
- `delay` 延迟

### **请求解析**

- `params`：路径参数（如 `:id`）。
- `requelst.url + new URL`：URL 查询参数。
- `requelst.headers.get('Header-Name')` 获取请求头。

**响应内容**

- `new Response('Hello world!')`  这个使用了浏览器原生 API
- `HttpResponse.text('Hello world!',{headers:{xxx:xxx}})`
- `HttpResponse.error()`  模拟网络错误

**常用功能性 API**

- `delay` - 添加响应时间
- `use` - 覆盖之前的mock

## 基础用法

参考文档：[浏览器集成](https://mswjs.io/docs/integrations/browser)

**CLI 初始化**

```bash
npx msw init <PUBLIC_DIR> --save
```

**最小配置**

```jsx
// src/mocks/browser.js
import { setupWorker } from 'msw/browser' 
import { http, HttpResponse } from 'msw';
// 定义接口拦截程序
const handlers = [
 http.get('/resource', () => {
    return HttpResponse.text('Hello World!')
  })
];

/* setupWorker 返回一个 Worker 实例 */
export const worker = setupWorker(...handlers)

worker.start() // 注意：在 React render 之前调用，也就是准备好mock后再挂载 React
worker.stop()
worker.use()
...
```

## example

```jsx
import { delay, http, HttpResponse } from "msw";
import { setupWorker } from "msw/browser";

const handlers = [
  http.post("/login", async ({ request }) => {
    const info = await request.formData();
    return HttpResponse.json(info);
  }),
  // 查询请求头信息
  http.get("/headers", async ({ request }) => {
    const headers = Object.fromEntries(request.headers.entries());
    // or
    const acceptValue = request.headers.get("accept");
    return HttpResponse.json({ headers, acceptValue });
  }),
  // 路径参数：/user/:id
  http.get("/user/:id", async ({ params }) => {
    const { id } = params;
    return HttpResponse.json({ id });
  }),
  // 查询参数：/user?id=123
  http.get("/user", async ({ request }) => {
    const url = new URL(request.url);
    const id = url.searchParams.get("id");
    const ids = url.searchParams.getAll("id");
    return HttpResponse.json({ id, ids });
  }),
  // 请求体 body
  http.post("/user", async ({ request }) => {
    const body = await request.json();
    const formData = await request.formData();

    return HttpResponse.json({body, formData});
  }),
  // 延迟响应
  http.get("/delay", async () => {
    await delay(3000);
    return HttpResponse.json({ message: "delay 3s" });
  }),
  // 模拟网络错误
  http.get("/error", () => {
    return HttpResponse.error();
  }),
  // 模拟错误
  http.get("/apples", () => {
    return new HttpResponse(null, {
      status: 403,
      statusText: "Out Of Apples",
      headers: { // 随便写的示例
        "Set-Cookie": "mySecret=abc-123",
        "X-Custom-Header": "yes",
      },
    });
  }),
  // 动态响应:有可能依赖另一套鉴权系统，暂时忽略
];

const worker = setupWorker(...handlers);
// 覆盖响应（应急测试）
worker.use(
  http.get("/apples", () => {
    return HttpResponse.text("hello world");
  })
  // ...more
);
worker.start();
```

## **资源**

- 官方文档：[mswjs.io](https://mswjs.io/docs/)
- GitHub 仓库：[github.com/mswjs/msw](https://github.com/mswjs/msw)
- 示例项目：[MSW Examples](https://github.com/mswjs/examples)